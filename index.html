<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RS Admin Tool</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f9f9f9;
      overflow-x: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .view {
      position: absolute;
      top: 10px;
      left: 0;
      width: 100%;
      height: calc(100vh - 20px);
      overflow-y: auto;
      transform: translateX(100%);
      opacity: 0;
      transition: transform 0.4s ease, opacity 0.4s ease;
      padding: 10px;
      box-sizing: border-box;
    }

    .view.active {
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
    }

    #menuButtons {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin-top: 10px;
    }

    #menuButtons .button,
    .button {
      display: block;
      width: 240px;
      margin: 10px 0;
      padding: 14px 20px;
      font-size: 16px;
      font-weight: bold;
      color: #ffffff;
      background-color: #2563EB;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      text-align: center;
      text-decoration: none;
    }

    #menuButtons .button:hover,
    .button:hover {
      background-color: #1e4bb8;
    }

    .back-button {
      display: inline-block;
      margin-bottom: 5px;
      cursor: pointer;
      color: #2563EB;
      font-weight: bold;
      font-size: 14px;
    }

    #agentsForm {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 300px;
      margin: 0 auto;
    }
    
    #agentsForm input {
      margin-top: 8px;
      padding: 6px;
      width: 120px;
    }
    
    #agentsForm .button {
      margin-top: 12px;
    }
    
    .or-divider {
      width: 100%;
      text-align: center;
      border-top: 1px solid #ccc;
      margin: 15px 0;
      position: relative;
    }
    
    .or-divider span {
      background: #f9f9f9;
      padding: 0 8px;
      position: relative;
      top: -11px;
      color: #666;
      font-size: 14px;
    }



    table {
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: left;
    }
    tr.highlight {
      background-color: #dbeafe;
    }

    .hidden {
      display: none;
    }
  </style>

  <script type='module' src='https://interfaces.zapier.com/assets/web-components/zapier-interfaces/zapier-interfaces.esm.js'></script>
  <script type="text/javascript" src="https://eia.followupboss.com/embeddedApps-v1.0.1.js"></script>
</head>

<body>
  <!-- Container for Current User Info -->
  <div id="currentUser"></div>

  <!-- Main Menu Buttons -->
  <div id="menuButtons" class="view">
    <button class="button" onclick="showView('redistributeView'); startRedistribute();">Redistribute</button>
    <button class="button" onclick="showView('zipSearchView')">Zip Code Search</button>
    <button class="button" onclick="showView('agentsView')">Show me available agents</button>
  </div>

  <!-- Redistribute View -->
  <div id="redistributeView" class="view">
    <span class="back-button" onclick="goBack()">‚Üê Back</span>
    <h2>Redistribute</h2>
    <div id="redistributeLoading" class="hidden">Redistributing...</div>
    <div id="redistributeResult" class="hidden"></div>
  </div>


  <!-- Zip Code Search View -->
  <div id="zipSearchView" class="view">
    <span class="back-button" onclick="goBack()">‚Üê Back</span>
    <zapier-interfaces-page-embed
      page-id='cm98vlopd001611ck4v8vy46l'
      no-background='false'
      allow-query-params='true'
      query-params=''
      style='max-width: 900px; height: 300px;'
    ></zapier-interfaces-page-embed>
  </div>

  <!-- Agents View -->
  <div id="agentsView" class="view">
    <span class="back-button" onclick="goBack()">‚Üê Back</span>
    <h2>Available Agents</h2>

  <div id="agentsForm">
    <label for="zipInput"><strong>Zip Code:</strong></label>
    <input type="text" id="zipInput" maxlength="5" />
    <button class="button" onclick="searchAgents()">Search</button>
  
    <div class="or-divider"><span>OR</span></div>
  
    <button class="button" onclick="useMostRecentInquiry()">Use Most Recent Inquiry</button>
  </div>

    <div id="agentsLoading" class="hidden" style="margin-top:20px;">
      Pulling Agent Details...
    </div>

    <div id="agentsTableContainer" class="hidden"></div>
  </div>

  <script>
    let zipGroupsData = [];

    // Load JSON data
    fetch("https://keiganakers634.github.io/zip-search-embed/zips.json")
      .then(response => {
        if (!response.ok) {
          throw new Error("Failed to load zip data JSON.");
        }
        return response.json();
      })
      .then(data => {
        zipGroupsData = data;
        console.log("Loaded zipGroupsData:", zipGroupsData);
      })
      .catch(err => {
        console.error("Error loading zipGroupsData:", err);
        alert("Could not load zip group data. Please try again later.");
      });

    async function verifyContextAndShowData() {
      const secret = "f38bd4dfb990d163f4f8bc070cc1da16";
      const params = new URLSearchParams(window.location.search);
      const contextB64 = params.get("context");
      const signature = params.get("signature");

      if (!contextB64 || !signature) {
        document.body.insertAdjacentHTML(
          "afterbegin",
          `<div style="background:#ffdddd; padding:10px; color:#800;">
            ‚ö†Ô∏è No context or signature found in URL.
          </div>`
        );
        return;
      }

      try {
        const decodedString = atob(contextB64);
        const contextObj = JSON.parse(decodedString);

        const enc = new TextEncoder();
        const key = await crypto.subtle.importKey(
          "raw",
          enc.encode(secret),
          { name: "HMAC", hash: "SHA-256" },
          false,
          ["sign"]
        );

        const sigBuffer = await crypto.subtle.sign(
          "HMAC",
          key,
          enc.encode(contextB64)
        );

        const calculatedSig = Array.from(new Uint8Array(sigBuffer))
          .map(b => b.toString(16).padStart(2, "0"))
          .join("");

        if (calculatedSig === signature) {
          console.log("‚úÖ Signature is valid!");

          const userName = contextObj?.user?.name || "(Unknown)";
          const userEmail = contextObj?.user?.email?.toLowerCase() || "(Unknown)";
          window.contextPersonId = contextObj?.person?.id || null;
          window.contextPersonZip = contextObj?.person?.postalCode || null;

          document.getElementById("currentUser").innerHTML = `
            <div style="background:#eef; padding:10px; border:1px solid #99f; margin-bottom:20px;">
              üë§ <strong>Current User:</strong> ${userName} (${userEmail})
            </div>
          `;

          const authorizedEmails = [
            "keigan.akers@robertslack.com",
            "fubadmin@robertslack.com",
            "cat.flanagan@robertslack.com",
            "gabe.cordova@robertslack.com",
            "francisco.garcia@robertslack.com"
          ];

          if (authorizedEmails.includes(userEmail)) {
            showView("menuButtons");
          } else {
            const unauthorizedHtml = `
              <div style="background:#ffdddd; padding:15px; color:#800; border:1px solid #f00; margin-top:20px;">
                ‚ùå <strong>Unauthorized user:</strong> This internal tool is for Call Center and Lisa team members!
              </div>
            `;
            document.body.insertAdjacentHTML("beforeend", unauthorizedHtml);
            console.log("‚ùå User unauthorized:", userEmail);
          }
        } else {
          console.error("‚ùå Signature verification failed!");
          document.body.insertAdjacentHTML(
            "afterbegin",
            `<div style="background:#ffdddd; padding:10px; color:#800;">
              ‚ùå Signature verification failed!
            </div>`
          );
        }
      } catch (e) {
        console.error("Error decoding context:", e);
        document.body.insertAdjacentHTML(
          "afterbegin",
          `<div style="background:#ffdddd; padding:10px; color:#800;">
            ‚ùå Error decoding context data.
          </div>`
        );
      }
    }

    verifyContextAndShowData();

    let activeView = null;

    function showView(viewId) {
      if (activeView) {
        activeView.classList.remove("active");
      }
      const newView = document.getElementById(viewId);
      if (newView) {
        newView.classList.add("active");
        activeView = newView;
      }

      // Only show current user info on the menu page
      document.getElementById("currentUser").style.display =
        viewId === "menuButtons" ? "block" : "none";
    }

    function goBack() {
      showView("menuButtons");
    
      // Reset the Available Agents view
      document.getElementById("zipInput").value = "";
      document.getElementById("agentsForm").classList.remove("hidden");
      document.getElementById("agentsLoading").classList.add("hidden");
      document.getElementById("agentsTableContainer").classList.add("hidden");
      document.getElementById("agentsTableContainer").innerHTML = "";
    }


    function searchAgents() {
      const zip = document.getElementById("zipInput").value.trim();
      if (!/^\d{5}$/.test(zip)) {
        alert("Please enter a valid zip code");
        return;
      }
      findGroupByZip(zip);
    }

    async function useMostRecentInquiry() {
      if (!window.contextPersonId) {
        alert("No personId found in context.");
        return;
      }
    
      const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
      const url = `https://api.followupboss.com/v1/events?limit=10&offset=0&personId=${window.contextPersonId}&type=Inquiry,%20Seller%20Inquiry,%20Property%20Inquiry,%20General%20Inquiry&hasProperty=true`;
    
      try {
        const res = await fetch(url, {
          headers: {
            "accept": "application/json",
            "authorization": `Basic ${apiKey}`
          }
        });
    
        if (!res.ok) throw new Error("API error fetching recent inquiries.");
    
        const data = await res.json();
        const events = data.events || [];
    
        if (events.length === 0) {
          alert("No recent inquiries with properties found for this contact.");
          return;
        }
    
        // Find the most recent event with property and property.code
        const sorted = events
          .filter(ev => ev.property && ev.property.code)
          .sort((a, b) => new Date(b.created) - new Date(a.created));
    
        if (sorted.length === 0) {
          alert("No recent property inquiry events contain a zip code.");
          return;
        }
    
        const zip = sorted[0].property.code;
        console.log("Using zip code from recent inquiry:", zip);
    
        findGroupByZip(zip);
    
      } catch (err) {
        alert("Failed to load recent inquiries.");
        console.error(err);
      }
    }

    function findGroupByZip(zip) {
      if (zipGroupsData.length === 0) {
        alert("Zip group data is still loading or unavailable.");
        return;
      }
      const entry = zipGroupsData.find(item => item.zip === zip);
      if (entry) {
        loadGroupData(entry);
      } else {
        alert("No matching group found for this zip code.");
      }
    }

    async function loadGroupData(entry) {
      document.getElementById("agentsForm").classList.add("hidden");
      document.getElementById("agentsLoading").classList.remove("hidden");

      const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
      const url = `https://api.followupboss.com/v1/groups/${entry.groupId}`;

      try {
        const res = await fetch(url, {
          headers: {
            "accept": "application/json",
            "authorization": `Basic ${apiKey}`
          }
        });

        if (!res.ok) throw new Error("API error");

        const data = await res.json();
        renderAgents(entry, data);
      } catch (err) {
        alert("Failed to pull agent details. Please try again.");
        console.error(err);
        goBack();
      }
    }

    function renderAgents(entry, groupData) {
      const container = document.getElementById("agentsTableContainer");
      container.innerHTML = "";

      const nextId = groupData.nextRoundRobinUser;
      const activeAgents = groupData.users.filter(u => !u.pauseLeadDistribution);

      let html = `
        <h3>Team: ${entry.team}</h3>
        <h4>Group: ${entry.group}</h4>
        <table>
          <tr>
            <th>Photo</th>
            <th>Name</th>
            <th>Action</th>
          </tr>
      `;

      for (const agent of activeAgents) {
        const isNext = agent.id === nextId;
        html += `
          <tr class="${isNext ? 'highlight' : ''}">
            <td><img src="${agent.picture["30x30"]}" alt="${agent.name}" /></td>
            <td>${agent.name}</td>
            <td>
              <button class="button" style="padding:5px 10px; font-size:12px;"
                onclick="reassignLead(${agent.id}, '${agent.name}')">
                ${isNext ? "Next in Line!" : "Reassign"}
              </button>
            </td>
          </tr>
        `;
      }

      html += "</table>";

      container.innerHTML = html;
      document.getElementById("agentsLoading").classList.add("hidden");
      container.classList.remove("hidden");
    }

    async function reassignLead(userId, userName) {
      if (!window.contextPersonId) {
        alert("Cannot reassign. PersonId not available.");
        return;
      }

      const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
      const url = `https://api.followupboss.com/v1/people/${window.contextPersonId}?mergeTags=false`;

      const payload = { assignedUserId: userId };

      try {
        const res = await fetch(url, {
          method: "PUT",
          headers: {
            "accept": "application/json",
            "content-type": "application/json",
            "authorization": `Basic ${apiKey}`
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("Failed PUT");

        const data = await res.json();

        if (data.assignedUserId === userId) {
          alert("Distributed!");
          goBack();
        } else {
          throw new Error("Response did not confirm assignment.");
        }
      } catch (err) {
        alert("That didn't work...Try again, or pick a different agent.");
        console.error(err);
      }
    }
    
    function startRedistribute() {
      document.getElementById("redistributeLoading").classList.remove("hidden");
      document.getElementById("redistributeResult").classList.add("hidden");
    
      getMostRecentZipForRedistribute();
    }
    
    async function getMostRecentZipForRedistribute() {
      if (!window.contextPersonId) {
        alert("Person ID missing from context.");
        goBack();
        return;
      }
    
      const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
      const url = `https://api.followupboss.com/v1/events?limit=10&offset=0&personId=${window.contextPersonId}&type=Inquiry%2C%20Seller%20Inquiry%2C%20Property%20Inquiry%2C%20General%20Inquiry&hasProperty=true`;
    
      try {
        const res = await fetch(url, {
          headers: {
            "accept": "application/json",
            "authorization": `Basic ${apiKey}`
          }
        });
    
        if (!res.ok) throw new Error("Events API error");
    
        const data = await res.json();
    
        const sorted = data.events
          .filter(ev => ev.property?.code)
          .sort((a, b) => new Date(b.created) - new Date(a.created));
    
        if (sorted.length > 0) {
          const zip = sorted[0].property.code;
          console.log("Most recent inquiry zip:", zip);
          findGroupAndRedistribute(zip);
        } else {
          alert("No recent inquiries with property zip found.");
          goBack();
        }
      } catch (e) {
        console.error(e);
        alert("Error retrieving recent inquiries.");
        goBack();
      }
    }
    
    async function findGroupAndRedistribute(zip) {
      const entry = zipGroupsData.find(item => item.zip === zip);
      if (!entry) {
        alert("No matching group found for this zip code.");
        goBack();
        return;
      }
    
      // Load group details
      const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
      const url = `https://api.followupboss.com/v1/groups/${entry.groupId}`;
    
      try {
        const res = await fetch(url, {
          headers: {
            "accept": "application/json",
            "authorization": `Basic ${apiKey}`
          }
        });
    
        if (!res.ok) throw new Error("Group API error");
    
        const data = await res.json();
    
        const nextUserId = data.nextRoundRobinUser;
        const nextUser = data.users.find(u => u.id === nextUserId);
    
        if (!nextUser) {
          alert("Could not determine next round-robin user.");
          goBack();
          return;
        }
    
        // Perform the reassignment
        await executeRedistribution(nextUser, entry, zip);
      } catch (e) {
        console.error(e);
        alert("Error pulling group details.");
        goBack();
      }
    }
    
    async function executeRedistribution(agent, entry, zip) {
      if (!window.contextPersonId) {
        alert("Person ID missing from context.");
        goBack();
        return;
      }
    
      const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
      const url = `https://api.followupboss.com/v1/people/${window.contextPersonId}?mergeTags=false`;
    
      const payload = { assignedUserId: agent.id };
    
      try {
        const res = await fetch(url, {
          method: "PUT",
          headers: {
            "accept": "application/json",
            "content-type": "application/json",
            "authorization": `Basic ${apiKey}`
          },
          body: JSON.stringify(payload)
        });
    
        if (!res.ok) throw new Error("PUT failed");
    
        const data = await res.json();
    
        if (data.assignedUserId === agent.id) {
          showRedistributeResult(agent, entry, zip);
        } else {
          throw new Error("Response did not confirm assignment.");
        }
      } catch (err) {
        console.error(err);
        alert("Redistribution failed. Try again.");
        goBack();
      }
    }
    
    function showRedistributeResult(agent, entry, zip) {
      const container = document.getElementById("redistributeResult");
    
      container.innerHTML = `
        <p><strong>Redistribution Complete!</strong></p>
        <p>Zip: ${zip}</p>
        <p>Team: ${entry.team}</p>
        <p>Group: ${entry.group}</p>
        <table>
          <tr>
            <th>Photo</th>
            <th>Name</th>
            <th>Action</th>
          </tr>
          <tr>
            <td><img src="${agent.picture["30x30"]}" alt="${agent.name}" /></td>
            <td>${agent.name}</td>
            <td>
              <button class="button" style="padding:5px 10px; font-size:12px;"
                onclick="scheduleAppointment()">
                Schedule an Appointment
              </button>
            </td>
          </tr>
        </table>
      `;
    
      document.getElementById("redistributeLoading").classList.add("hidden");
      container.classList.remove("hidden");
    }

    function scheduleAppointment() {
      alert("Appointment scheduling coming soon!");
    }

    
  </script>
</body>
</html>
