<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RS Admin Tool</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f9f9f9;
      overflow-x: hidden;
    }

    .view {
      position: absolute;
      top: 80px;
      left: 0;
      width: 100%;
      transform: translateX(100%);
      opacity: 0;
      transition: transform 0.4s ease, opacity 0.4s ease;
    }

    .view.active {
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
    }

    #menuButtons {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-top: 40px;
    }

    #menuButtons .button {
      display: block;
      width: 240px;
      margin: 10px 0;
      padding: 14px 20px;
      font-size: 16px;
      font-weight: bold;
      color: #ffffff;
      background-color: #2563EB;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      text-align: center;
      text-decoration: none;
    }

    #menuButtons .button:hover {
      background-color: #1e4bb8;
    }

    .back-button {
      display: inline-block;
      margin-bottom: 10px;
      cursor: pointer;
      color: #2563EB;
      font-weight: bold;
    }
  </style>

  <script type='module' src='https://interfaces.zapier.com/assets/web-components/zapier-interfaces/zapier-interfaces.esm.js'></script>
  <script type="text/javascript" src="https://eia.followupboss.com/embeddedApps-v1.0.1.js"></script>
</head>

<body>
  <!-- Container for Current User Info -->
  <div id="currentUser"></div>

  <!-- Container for the main menu buttons -->
  <div id="menuButtons" class="view">
    <button class="button" onclick="showView('redistributeView')">Redistribute</button>
    <button class="button" onclick="showView('zipSearchView')">Zip Code Search</button>
    <button class="button" onclick="showView('agentsView')">Show me available agents</button>
  </div>

  <!-- Redistribute View -->
  <div id="redistributeView" class="view">
    <span class="back-button" onclick="goBack()">‚Üê Back</span>
    <h2>Redistribute</h2>
    <p>Coming Soon!</p>
  </div>

  <!-- Agents View -->
  <div id="agentsView" class="view">
    <span class="back-button" onclick="goBack()">‚Üê Back</span>
    <h2>Available Agents</h2>
    <p>Coming Soon!</p>
  </div>

  <!-- Zip Code Search (Zapier Embed) View -->
  <div id="zipSearchView" class="view">
    <span class="back-button" onclick="goBack()">‚Üê Back</span>
    <zapier-interfaces-page-embed
      page-id='cm98vlopd001611ck4v8vy46l'
      no-background='false'
      allow-query-params='true'
      query-params=''
      style='max-width: 900px; height: 500px;'
    ></zapier-interfaces-page-embed>
  </div>

  <script>
    async function verifyContextAndShowData() {
      const secret = "f38bd4dfb990d163f4f8bc070cc1da16";

      const params = new URLSearchParams(window.location.search);
      const contextB64 = params.get("context");
      const signature = params.get("signature");

      if (!contextB64 || !signature) {
        document.body.insertAdjacentHTML(
          "afterbegin",
          `<div style="background:#ffdddd; padding:10px; color:#800;">
            ‚ö†Ô∏è No context or signature found in URL.
          </div>`
        );
        return;
      }

      try {
        const decodedString = atob(contextB64);
        const contextObj = JSON.parse(decodedString);

        // Validate signature
        const enc = new TextEncoder();
        const key = await crypto.subtle.importKey(
          "raw",
          enc.encode(secret),
          { name: "HMAC", hash: "SHA-256" },
          false,
          ["sign"]
        );

        const sigBuffer = await crypto.subtle.sign(
          "HMAC",
          key,
          enc.encode(contextB64)
        );

        const calculatedSig = Array.from(new Uint8Array(sigBuffer))
          .map(b => b.toString(16).padStart(2, "0"))
          .join("");

        if (calculatedSig === signature) {
          console.log("‚úÖ Signature is valid!");

          const userName = contextObj?.user?.name || "(Unknown)";
          const userEmail = contextObj?.user?.email?.toLowerCase() || "(Unknown)";

          document.getElementById("currentUser").innerHTML = `
            <div style="background:#eef; padding:10px; border:1px solid #99f; margin-bottom:20px;">
              üë§ <strong>Current User:</strong> ${userName} (${userEmail})
            </div>
          `;

          const authorizedEmails = [
            "keigan.akers@robertslack.com",
            "fubadmin@robertslack.com",
            "cat.flanagan@robertslack.com",
            "gabe.cordova@robertslack.com",
            "francisco.garcia@robertslack.com"
          ];

          if (authorizedEmails.includes(userEmail)) {
            showView("menuButtons");
          } else {
            const unauthorizedHtml = `
              <div style="background:#ffdddd; padding:15px; color:#800; border:1px solid #f00; margin-top:20px;">
                ‚ùå <strong>Unauthorized user:</strong> This internal tool is for Call Center and Lisa team members!
              </div>
            `;
            document.body.insertAdjacentHTML("beforeend", unauthorizedHtml);
            console.log("‚ùå User unauthorized:", userEmail);
          }
        } else {
          console.error("‚ùå Signature verification failed!");
          document.body.insertAdjacentHTML(
            "afterbegin",
            `<div style="background:#ffdddd; padding:10px; color:#800;">
              ‚ùå Signature verification failed!
            </div>`
          );
        }
      } catch (e) {
        console.error("Error decoding context:", e);
        document.body.insertAdjacentHTML(
          "afterbegin",
          `<div style="background:#ffdddd; padding:10px; color:#800;">
            ‚ùå Error decoding context data.
          </div>`
        );
      }
    }

    verifyContextAndShowData();

    let activeView = null;

    function showView(viewId) {
      // Slide out any active view
      if (activeView) {
        activeView.classList.remove("active");
      }

      // Slide in the requested view
      const newView = document.getElementById(viewId);
      if (newView) {
        newView.classList.add("active");
        activeView = newView;
      }
    }

    function goBack() {
      showView("menuButtons");
    }
  </script>
</body>
</html>
