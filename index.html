<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RS Admin Tool</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f9f9f9;
      overflow-x: hidden;
    }

    .view {
      display: none;
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
    }
    
    .view.active {
      display: block;
    }

    #menuButtons {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin-top: 10px;
    }

    #menuButtons .button,
    .button {
      display: block;
      width: 240px;
      margin: 10px 0;
      padding: 14px 20px;
      font-size: 16px;
      font-weight: bold;
      color: #ffffff;
      background-color: #2563EB;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      text-align: center;
      text-decoration: none;
    }

    #menuButtons .button:hover,
    .button:hover {
      background-color: #1e4bb8;
    }

    .back-button {
      display: inline-block;
      margin-bottom: 5px;
      cursor: pointer;
      color: #2563EB;
      font-weight: bold;
      font-size: 14px;
    }

    #agentsForm {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 300px;
      margin: 0 auto;
    }
    
    #agentsForm input {
      margin-top: 8px;
      padding: 6px;
      width: 120px;
    }
    
    #agentsForm .button {
      margin-top: 12px;
    }
    
    .or-divider {
      width: 100%;
      text-align: center;
      border-top: 1px solid #ccc;
      margin: 15px 0;
      position: relative;
    }
    
    .or-divider span {
      background: #f9f9f9;
      padding: 0 8px;
      position: relative;
      top: -11px;
      color: #666;
      font-size: 14px;
    }



    table {
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: left;
    }
    tr.highlight {
      background-color: #dbeafe;
    }

    .hidden {
      display: none !important;
    }

	#calendarContainer, #timeSlotsContainer, #calendarLoading {
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	}

	.calendar-grid {
	  display: grid;
	  grid-template-columns: repeat(7, 1fr);
	  gap: 8px;
	  margin-top: 20px;
	}

	.calendar-grid button {
	  width: 100%;
	  padding: 10px 5px;
	  font-size: 14px;
	}

	.time-grid {
	  display: grid;
	  grid-template-columns: repeat(5, 1fr);
	  gap: 8px;
	  margin-top: 20px;
	}

	.time-grid .button {
	  width: auto;
	  min-width: 80px;
	  max-width: 100px;
	  padding: 6px 8px;
	  font-size: 13px;
	}

	#notificationBanner {
	  position: fixed;
	  top: 0;
	  left: 0;
	  right: 0;
	  background-color: #2563EB;
	  color: white;
	  text-align: center;
	  padding: 12px;
	  font-weight: bold;
	  z-index: 1000;
	  transition: opacity 0.4s ease;
	}
	
	#notificationBanner.error {
	  background-color: #dc2626;
	}
	
	#notificationBanner.success {
	  background-color: #16a34a;
	}
	
	#notificationBanner.warning {
	  background-color: #f59e0b;
	}
	
	#notificationBanner.hidden {
	  opacity: 0;
	  pointer-events: none;
	}
	  
	.button.busy-slot {
	  background-color: #e5e7eb; /* Light gray */
	  color: #6b7280;            /* Muted gray text */
	  text-decoration: line-through;
	  cursor: not-allowed;
	}

  

  </style>

  <script type='module' src='https://interfaces.zapier.com/assets/web-components/zapier-interfaces/zapier-interfaces.esm.js'></script>
  <script type="text/javascript" src="https://eia.followupboss.com/embeddedApps-v1.0.1.js"></script>
</head>

<body>
  <div id="notificationBanner" class="hidden"></div> <!-- üîî Add this line -->
  <!-- Container for Current User Info -->
  <div id="currentUser"></div>

  <!-- Main Menu Buttons -->
  <div id="menuButtons" class="view">
    <button class="button" onclick="showView('redistributeView'); startRedistribute();">‚ö†Ô∏è Instant Assign ‚ö†Ô∏è</button>
    <button class="button" onclick="showView('zipSearchView')">üìÖ Appointment Assistant</button>
    <button class="button" onclick="showView('agentsView')">üîç Find available agents</button>
  </div>

  <!-- Redistribute View -->
  <div id="redistributeView" class="view">
    <span class="back-button" onclick="goBack()">‚Üê Back</span>
    <div id="redistributeLoading" class="hidden">Redistributing...</div>
    <div id="redistributeResult" class="hidden"></div>
	<div id="calendarLoading" class="hidden">
	  <h3 style="text-align:center; margin-top:40px;">
		Retrieving upcoming Appointment details and generating availability...
	  </h3>
	</div>

	<div id="calendarContainer" class="hidden"></div>
    <div id="timeSlotsContainer" class="hidden"></div>
    <div id="appointmentFormContainer" class="hidden"></div>
  </div>


  <div id="zipSearchView" class="view">
    <span class="back-button" onclick="goBack()">‚Üê Back</span>
    <h2>Appointment Setter</h2>

    <div id="apptSetterOptions" style="display: flex; flex-direction: column; align-items: center; gap: 16px; margin-top: 20px;">
      <button class="button" onclick="initApptSetterForAssignedAgent()">For this Agent</button>
      <button class="button" onclick="showHelpMeFindForm()">Help me find one!</button>
    </div>

    <div id="helpMeFindForm" class="hidden" style="margin-top: 20px; display: flex; flex-direction: column; align-items: center;">
      <label for="zipInputHelper"><strong>Zip Code:</strong></label>
      <input type="text" id="zipInputHelper" maxlength="5" />
      <button class="button" onclick="searchAvailableAgentsByZip()">Search</button>

      <div class="or-divider"><span>OR</span></div>
      <button class="button" onclick="useRecentInquiryZipHelper()">Use Most Recent Inquiry</button>
    </div>
  </div>

  <!-- Agents View -->
  <div id="agentsView" class="view">
    <span class="back-button" onclick="goBack()">‚Üê Back</span>
    <h2>Available Agents</h2>

  <div id="agentsForm">
    <label for="zipInput"><strong>Zip Code:</strong></label>
    <input type="text" id="zipInput" maxlength="5" />
    <button class="button" onclick="searchAgents()">Search</button>
  
    <div class="or-divider"><span>OR</span></div>
  
    <button class="button" onclick="useMostRecentInquiry()">Use Most Recent Inquiry</button>
  </div>

    <div id="agentsLoading" class="hidden" style="margin-top:20px;">
      Pulling Agent Details...
    </div>

    <div id="agentsTableContainer" class="hidden"></div>
  </div>

  <script>
    let zipGroupsData = [];

    // Load JSON data
    fetch("https://keiganakers634.github.io/zip-search-embed/zips.json")
      .then(response => {
        if (!response.ok) {
          throw new Error("Failed to load zip data JSON.");
        }
        return response.json();
      })
      .then(data => {
        zipGroupsData = data;
        console.log("Loaded zipGroupsData:", zipGroupsData);
      })
      .catch(err => {
        console.error("Error loading zipGroupsData:", err);
        showBanner("Failed to load Group Data. Try again.", "error")
      });

	async function verifyContextAndShowData() {
	  const secret = "f38bd4dfb990d163f4f8bc070cc1da16";
	  const params = new URLSearchParams(window.location.search);
	  const contextB64 = params.get("context");
	  const signature = params.get("signature");
	
	  if (!contextB64 || !signature) {
	    document.body.insertAdjacentHTML(
	      "afterbegin",
	      `<div style="background:#ffdddd; padding:10px; color:#800;">
	        ‚ö†Ô∏è No context or signature found in URL.
	      </div>`
	    );
	    return;
	  }
	
	  try {
	    const decodedString = atob(contextB64);
	    const contextObj = JSON.parse(decodedString);
	
	    const enc = new TextEncoder();
	    const key = await crypto.subtle.importKey(
	      "raw",
	      enc.encode(secret),
	      { name: "HMAC", hash: "SHA-256" },
	      false,
	      ["sign"]
	    );
	
	    const sigBuffer = await crypto.subtle.sign(
	      "HMAC",
	      key,
	      enc.encode(contextB64)
	    );
	
	    const calculatedSig = Array.from(new Uint8Array(sigBuffer))
	      .map(b => b.toString(16).padStart(2, "0"))
	      .join("");
	
	    if (calculatedSig === signature) {
	      console.log("‚úÖ Signature is valid!");
	
	      const userName = contextObj?.user?.name || "(Unknown)";
	      const userEmail = contextObj?.user?.email?.toLowerCase() || "(Unknown)";
	      window.contextPersonId = contextObj?.person?.id || null;
	      window.contextPersonZip = contextObj?.person?.postalCode || null;
	      window.contextPersonName = contextObj?.person?.name || null;
	
	      window.contextUserId = contextObj?.user?.id || null;
	      window.contextUserName = contextObj?.user?.name || null;
	
	      document.getElementById("currentUser").innerHTML = `
	        <div style="background:#eef; padding:10px; border:1px solid #99f; margin-bottom:20px;">
	          üë§ <strong>Current User:</strong> ${userName} (${userEmail})
	        </div>
	      `;
	
	      const authorizedEmails = [
	        "keigan.akers@robertslack.com",
	        "fubadmin@robertslack.com",
	        "cat.flanagan@robertslack.com",
	        "gabe.cordova@robertslack.com",
	        "francisco.garcia@robertslack.com",
		"matt.brown@robertslack.com",
		"diedre.lambert@robertslack.com"
	      ];
	
	      if (authorizedEmails.includes(userEmail)) {
	        window.isAuthorized = true;
	        showView("menuButtons");
	      } else {
	        window.isAuthorized = false;
	        document.getElementById("menuButtons").style.display = "none";
	
	        document.body.insertAdjacentHTML(
	          "beforeend",
	          `<div style="background:#ffdddd; padding:15px; color:#800; border:1px solid #f00; margin-top:20px;">
	            ‚ùå <strong>Unauthorized user:</strong> This internal tool is currently for RS Admin Staff Only!
	          </div>`
	        );
	
	        console.log("‚ùå User unauthorized:", userEmail);
	      }
	    } else {
	      console.error("‚ùå Signature verification failed!");
	      document.body.insertAdjacentHTML(
	        "afterbegin",
	        `<div style="background:#ffdddd; padding:10px; color:#800;">
	          ‚ùå Signature verification failed!
	        </div>`
	      );
	    }
	  } catch (e) {
	    console.error("Error decoding context:", e);
	    document.body.insertAdjacentHTML(
	      "afterbegin",
	      `<div style="background:#ffdddd; padding:10px; color:#800;">
	        ‚ùå Error decoding context data.
	      </div>`
	    );
	  }
	}


    verifyContextAndShowData();

    let activeView = null;

	function showView(viewId) {
	  if (!window.isAuthorized && viewId !== "menuButtons") {
		showBanner("Sorry! This Tool is currently only for Admin Staff. More info Coming Soon!", "warning");
		return;
	  }

	  // Hide all top-level views
	  document.querySelectorAll(".view").forEach(v => {
		v.classList.remove("active");
	  });

	  // Clear all inner sub-views for consistent behavior
	  [
		"calendarLoading",
		"calendarContainer",
		"timeSlotsContainer",
		"appointmentFormContainer",
		"agentsLoading",
		"agentsTableContainer",
	  ].forEach(id => {
		const el = document.getElementById(id);
		if (el) {
		  el.classList.add("hidden");
		  if (["agentsTableContainer", "appointmentFormContainer"].includes(id)) {
		    el.innerHTML = "";
		  }
		}
	  });

	  // Show the requested view
	  const newView = document.getElementById(viewId);
	  if (newView) {
		newView.classList.add("active");
		activeView = newView;
	  }

	  document.getElementById("currentUser").style.display =
		viewId === "menuButtons" ? "block" : "none";
	}




    function goBack() {
      showView("menuButtons");
    
      // Reset the Available Agents view
      document.getElementById("zipInput").value = "";
      document.getElementById("agentsForm").classList.remove("hidden");
      document.getElementById("agentsLoading").classList.add("hidden");
      document.getElementById("agentsTableContainer").classList.add("hidden");
      document.getElementById("agentsTableContainer").innerHTML = "";
    }


	function searchAgents() {
	  const zip = document.getElementById("zipInput").value.trim();
	  if (!/^\d{5}$/.test(zip)) {
		showBanner("Please enter a valid zip code.", "warning");
		return;
	  }
	  window.lastZipSearch = zip;
	  findGroupByZip(zip);
	}


    async function useMostRecentInquiry() {
      if (!window.contextPersonId) {
        showBanner("No PersonId Found", "warning");
        return;
      }
    
      const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
      const url = `https://api.followupboss.com/v1/events?limit=10&offset=0&personId=${window.contextPersonId}&type=Inquiry,%20Seller%20Inquiry,%20Property%20Inquiry,%20General%20Inquiry&hasProperty=true`;
    
      try {
        const res = await fetch(url, {
          headers: {
            "accept": "application/json",
            "authorization": `Basic ${apiKey}`
          }
        });
    
        if (!res.ok) throw new Error("API error fetching recent inquiries.");
    
        const data = await res.json();
        const events = data.events || [];
    
        if (events.length === 0) {
          showBanner("No Valid property inquiries on this lead! Try typing a zip code", "warning");
          return;
        }
    
        // Find the most recent event with property and property.code
        const sorted = events
          .filter(ev => ev.property && ev.property.code)
          .sort((a, b) => new Date(b.created) - new Date(a.created));
    
        if (sorted.length === 0) {
          showBanner("No Valid property inquiries on this lead! Try typing a zip code", "warning");
          return;
        }
    
		const zip = sorted[0].property.code;
		console.log("Using zip code from recent inquiry:", zip);
		window.lastZipSearch = zip;
		findGroupByZip(zip);

    
      } catch (err) {
        showBanner("Failed to load recent inquiry data for this lead...Try entering a Zip instead", "error");
        console.error(err);
      }
    }

	async function getLatLngForZip(zip) {
	  const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
	  if (!res.ok) throw new Error("Failed to get location data for ZIP");
	  const data = await res.json();
	
	  const place = data.places[0];
	  return {
	    lat: parseFloat(place.latitude),
	    lng: parseFloat(place.longitude)
	  };
	}
	
	function haversineDistance(lat1, lon1, lat2, lon2) {
	  const toRad = angle => (angle * Math.PI) / 180;
	  const R = 6371;
	  const dLat = toRad(lat2 - lat1);
	  const dLon = toRad(lon2 - lon1);
	  const a = Math.sin(dLat / 2) ** 2 +
	            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
	            Math.sin(dLon / 2) ** 2;
	  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
	  return R * c;
	}
	
	async function findClosestZipEntry(zip) {
	  try {
	    const { lat, lng } = await getLatLngForZip(zip);
	
	    let closest = null;
	    let minDistance = Infinity;
	
	    for (const entry of zipGroupsData) {
	      if (!entry.lat || !entry.lng) continue;
	
	      const dist = haversineDistance(lat, lng, entry.lat, entry.lng);
	      if (dist < minDistance) {
	        minDistance = dist;
	        closest = entry;
	      }
	    }
	
	    return closest;
	  } catch (err) {
	    console.error("Geolocation lookup failed:", err);
	    return null;
	  }
	}



	function findGroupByZip(zip) {
	  if (zipGroupsData.length === 0) {
		showBanner("Group Data for this Zip is unavailable", "error");
		return;
	  }

	  const exactEntry = zipGroupsData.find(item => item.zip === zip);
	  if (exactEntry) {
		loadGroupData(exactEntry, zip);
	  } else {
		const closestEntry = findClosestZipEntry(zip);
		if (closestEntry) {
		  showBanner(`‚ö†Ô∏è No exact match for ${zip}. Using closest zip ${closestEntry.zip}.`, "warning");
		  loadGroupData(closestEntry, zip);
		} else {
		  showBanner("We have no Groups Near this zip code!", "error");
		}
	  }
	}


    async function loadGroupData(entry, searchedZip) {
      document.getElementById("agentsForm").classList.add("hidden");
      document.getElementById("agentsLoading").classList.remove("hidden");

      const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
      const url = `https://api.followupboss.com/v1/groups/${entry.groupId}`;

      try {
        const res = await fetch(url, {
          headers: {
            "accept": "application/json",
            "authorization": `Basic ${apiKey}`
          }
        });

        if (!res.ok) throw new Error("API error");

        const data = await res.json();
		renderAgents(entry, data, searchedZip);
      } catch (err) {
        showBanner("No Group data available for this zip...Try another", "error");
        console.error(err);
        goBack();
      }
    }

    function renderAgents(entry, groupData, searchedZip) {
      const container = document.getElementById("agentsTableContainer");
      container.innerHTML = "";

      const nextId = groupData.nextRoundRobinUser;
      const activeAgents = groupData.users.filter(u => !u.pauseLeadDistribution);

      let html = `
        <h3>Team: ${entry.team}</h3>
        <h4>Group: ${entry.group}</h4>
		<h4>Zip Used: ${searchedZip}</h4>
        <table>
          <tr>
            <th>Photo</th>
            <th>Name</th>
            <th>Action</th>
          </tr>
      `;

      for (const agent of activeAgents) {
        const isNext = agent.id === nextId;
        html += `
          <tr class="${isNext ? 'highlight' : ''}">
            <td><img src="${agent.picture["60x60"]}" alt="${agent.name}" /></td>
            <td>${agent.name}</td>
            <td>
              <button class="button" style="padding:5px 10px; font-size:12px;"
                onclick="reassignLead(${agent.id}, '${agent.name}')">
                ${isNext ? "Next in Line!" : "Reassign"}
              </button>
            </td>
          </tr>
        `;
      }

      html += "</table>";

      container.innerHTML = html;
      document.getElementById("agentsLoading").classList.add("hidden");
      container.classList.remove("hidden");
    }

	function showHelpMeFindForm() {
	  document.getElementById("apptSetterOptions").classList.add("hidden");
	  document.getElementById("helpMeFindForm").classList.remove("hidden");
	}
	
	function searchAvailableAgentsByZip() {
	  const zip = document.getElementById("zipInputHelper").value.trim();
	  if (!/^\d{5}$/.test(zip)) {
	    showBanner("Please enter a valid zip code.", "warning");
	    return;
	  }
	  findAgentsWithAvailability(zip);
	}
	
	async function useRecentInquiryZipHelper() {
	  if (!window.contextPersonId) {
	    alert("Missing personId in context.");
	    return;
	  }
	
	  const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
	  const url = `https://api.followupboss.com/v1/events?limit=10&offset=0&personId=${window.contextPersonId}&type=Inquiry,%20Seller%20Inquiry,%20Property%20Inquiry,%20General%20Inquiry&hasProperty=true`;
	
	  try {
	    const res = await fetch(url, {
	      headers: {
	        "accept": "application/json",
	        "authorization": `Basic ${apiKey}`
	      }
	    });
	
	    if (!res.ok) throw new Error("Failed to load recent inquiries.");
	
	    const data = await res.json();
	    const events = data.events || [];
	
	    const sorted = events.filter(ev => ev.property?.code).sort((a, b) => new Date(b.created) - new Date(a.created));
	
	    if (sorted.length === 0) {
	      showBanner("No valid Property inquiries found for this lead! Try using your own zip code.", "warning");
	      return;
	    }
	
	    const zip = sorted[0].property.code;
	    findAgentsWithAvailability(zip);
	
	  } catch (err) {
	    showBanner("No valid Property inquiries found for this lead! Try using your own zip code.", "warning");
	    console.error(err);
	  }
	}
	
	async function findAgentsWithAvailability(zip) {
	  const entry = zipGroupsData.find(item => item.zip === zip) || findClosestZipEntry(zip);
	  if (!entry) {
	    showBanner("No matching Groups for this zip code!", "error");
	    return;
	  }
	
	  const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
	  const url = `https://api.followupboss.com/v1/groups/${entry.groupId}`;
	
	  try {
	    const res = await fetch(url, {
	      headers: {
	        "accept": "application/json",
	        "authorization": `Basic ${apiKey}`
	      }
	    });
	
	    if (!res.ok) throw new Error("Failed to load group data");
	
	    const data = await res.json();
	    const activeAgents = data.users.filter(u => !u.pauseLeadDistribution);

	    // ‚úÖ Show a notification before pulling appointments
	    showBanner(`Pulling appointment details for ${activeAgents.length} agents in ${entry.group}`, "info");
		  
	    // Fetch appointment data for each agent in parallel
	    const appointmentPromises = activeAgents.map(agent => fetch(`https://api.followupboss.com/v1/appointments?userId=${agent.id}&limit=100&offset=0`, {
	      headers: {
	        "accept": "application/json",
	        "authorization": `Basic ${apiKey}`
	      }
	    }).then(res => res.ok ? res.json() : null).then(json => ({ agent, appointments: json?.appointments || [] })));
	
	    const results = await Promise.all(appointmentPromises);
	
	    window.groupAgentAvailability = results.map(r => ({
	      agent: r.agent,
	      busy: parseBusyWindows(r.appointments, r.agent.id)
	    }));
	    showBanner("‚úÖ Appointment availability loaded!", "success");
	    renderGroupAvailabilityCalendar();
	
	  } catch (err) {
	    showBanner("Hm...Failure to load agent availability", "error");
	    console.error(err);
	  }
	}
	function renderGroupAvailabilityCalendar() {
	  showView("redistributeView");
	
	  const container = document.getElementById("calendarContainer");
	  container.classList.remove("hidden");
	  container.innerHTML = "<h3>Select a Date:</h3>";
	
	  const grid = document.createElement("div");
	  grid.className = "calendar-grid";
	
	  const today = new Date();
	  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
	
	  for (const d of dayNames) {
	    const header = document.createElement("div");
	    header.style.fontWeight = "bold";
	    header.style.textAlign = "center";
	    header.textContent = d;
	    grid.appendChild(header);
	  }
	
	  const weekday = today.getDay();
	  for (let i = 0; i < weekday; i++) {
	    grid.appendChild(document.createElement("div"));
	  }
	
	  for (let i = 0; i < 14; i++) {
	    const date = new Date(today);
	    date.setDate(today.getDate() + i);
	
	    const btn = document.createElement("button");
	    btn.textContent = date.getDate();
	    btn.className = "button";
	    btn.style.fontSize = "14px";
	    btn.onclick = () => renderTimeSlotChooser(date);
	
	    grid.appendChild(btn);
	  }
	
	  container.appendChild(grid);
	}

	function renderTimeSlotChooser(date) {
	  document.getElementById("calendarContainer").classList.add("hidden");
	  document.getElementById("timeSlotsContainer").classList.remove("hidden");
	
	  const container = document.getElementById("timeSlotsContainer");
	  container.innerHTML = `
	    <span class="back-button" onclick="goBackToCalendar()">‚Üê Back to Calendar</span>
	    <h4>${date.toDateString()}</h4>
	  `;
	
	  const grid = document.createElement("div");
	  grid.className = "time-grid";
	
	  for (let hour = 9; hour <= 18; hour++) {
	    const slotStart = new Date(date);
	    slotStart.setHours(hour, 0, 0, 0);
	    const slotEnd = new Date(slotStart);
	    slotEnd.setHours(hour + 1);
	
	  const available = window.groupAgentAvailability.filter(({ busy }) => {
	    return !busy.some(b => {
	      const oneHour = 60 * 60 * 1000;
	      const startsTooCloseBefore = (slotStart - b.start) > 0 && (slotStart - b.start) < oneHour;
	      const endsTooCloseAfter = (b.end - slotEnd) > 0 && (b.end - slotEnd) < oneHour;
	      const overlaps = slotStart < b.end && slotEnd > b.start;
	      return overlaps || startsTooCloseBefore || endsTooCloseAfter;
	    });
	  });
	
	    const btn = document.createElement("button");
	    btn.textContent = `${slotStart.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })} - ${available.length} available`;
	    btn.className = "button";
	    btn.disabled = available.length === 0;
	    btn.onclick = () => displayAvailableAgentsForSlot(available, slotStart);
	
	    grid.appendChild(btn);
	  }
	
	  container.appendChild(grid);
	}

	function displayAvailableAgentsForSlot(agentList, slotStart) {
	  document.getElementById("timeSlotsContainer").classList.add("hidden");
	
	  const container = document.getElementById("appointmentFormContainer");
	  container.classList.remove("hidden");
	
	  const readableTime = slotStart.toLocaleString([], {
	    weekday: 'short',
	    hour: 'numeric',
	    minute: '2-digit'
	  });
	
	  let html = `
	    <span class="back-button" onclick="goBackToCalendar()">‚Üê Back</span>
	    <h4>Available Agents for ${readableTime}</h4>
	    <table>
	      <tr><th>Photo</th><th>Name</th><th>Action</th></tr>
	  `;
	
	  for (const { agent } of agentList) {
	    html += `
	      <tr>
	        <td><img src="${agent.picture["60x60"]}" alt="${agent.name}" /></td>
	        <td>${agent.name}</td>
	        <td>
	          <button class="button" style="padding: 5px 10px; font-size: 12px;" onclick="assignAgentToSlot(${agent.id}, '${agent.name}', '${slotStart.toISOString()}')">
	            Assign and Schedule
	          </button>
	        </td>
	      </tr>
	    `;
	  }
	
	  html += `</table>`;
	  container.innerHTML = html;
	}

	  
    async function reassignLead(userId, userName) {
      if (!window.contextPersonId) {
        alert("Cannot reassign. PersonId not available.");
        return;
      }

      const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
      const url = `https://api.followupboss.com/v1/people/${window.contextPersonId}?mergeTags=false`;

	  const payload = {
	    assignedUserId: userId,
	    customLastAssignedAgent: userName,
	    customLastAssignedAgentDate: new Date().toISOString(),
	    customLastAssigningUser: window.contextUserName
	  };

      try {
        const res = await fetch(url, {
          method: "PUT",
          headers: {
            "accept": "application/json",
            "content-type": "application/json",
            "authorization": `Basic ${apiKey}`
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("Failed PUT");

        const data = await res.json();

		if (data.assignedUserId === userId) {
		  // Instead of just going back, show a result view
		  showAvailableAgentResult(userId, userName);
		} else {
		  throw new Error("Response did not confirm assignment.");
		}
      } catch (err) {
        showBanner("That didn't work...Try again, or pick a different agent.", "error");
        console.error(err);
      }
    }
    
    function startRedistribute() {
      document.getElementById("redistributeLoading").classList.remove("hidden");
      document.getElementById("redistributeResult").classList.add("hidden");
    
      getMostRecentZipForRedistribute();
    }
    
    async function getMostRecentZipForRedistribute() {
      if (!window.contextPersonId) {
        alert("Person ID missing from context.");
        goBack();
        return;
      }
    
      const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
      const url = `https://api.followupboss.com/v1/events?limit=10&offset=0&personId=${window.contextPersonId}&type=Inquiry%2C%20Seller%20Inquiry%2C%20Property%20Inquiry%2C%20General%20Inquiry&hasProperty=true`;
    
      try {
        const res = await fetch(url, {
          headers: {
            "accept": "application/json",
            "authorization": `Basic ${apiKey}`
          }
        });
    
        if (!res.ok) throw new Error("Events API error");
    
        const data = await res.json();
    
        const sorted = data.events
          .filter(ev => ev.property?.code)
          .sort((a, b) => new Date(b.created) - new Date(a.created));
    
        if (sorted.length > 0) {
          const zip = sorted[0].property.code;
          console.log("Most recent inquiry zip:", zip);
          findGroupAndRedistribute(zip);
        } else {
          alert("No recent inquiries with property zip found.");
          goBack();
        }
      } catch (e) {
        console.error(e);
        alert("Error retrieving recent inquiries.");
        goBack();
      }
    }
    
    async function findGroupAndRedistribute(zip) {
	  let entry = zipGroupsData.find(item => item.zip === zip);
	  if (!entry) {
	    entry = findClosestZipEntry(zip);
	    if (!entry) {
	  	  alert("No matching group found for this zip code.");
		  goBack();
		  return;
	    }
	  console.log(`‚ö†Ô∏è No exact match for ${zip}. Using closest zip ${entry.zip}.`);
	}
    
      // Load group details
      const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
      const url = `https://api.followupboss.com/v1/groups/${entry.groupId}`;
    
      try {
        const res = await fetch(url, {
          headers: {
            "accept": "application/json",
            "authorization": `Basic ${apiKey}`
          }
        });
    
        if (!res.ok) throw new Error("Group API error");
    
        const data = await res.json();
    
        const nextUserId = data.nextRoundRobinUser;
        const nextUser = data.users.find(u => u.id === nextUserId);
    
        if (!nextUser) {
          showBanner("Couldn't find the next Agent in line!", "error");
          goBack();
          return;
        }
    
        // Perform the reassignment
        await executeRedistribution(nextUser, entry, zip);
      } catch (e) {
        console.error(e);
        showBanner("Couldn't pull group details", "error");
        goBack();
      }
    }
    
    async function executeRedistribution(agent, entry, zip) {
      if (!window.contextPersonId) {
        alert("Person ID missing from context.");
        goBack();
        return;
      }
    
      const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
      const url = `https://api.followupboss.com/v1/people/${window.contextPersonId}?mergeTags=false`;
    
	  const payload = {
	    assignedUserId: agent.id,
	    customLastAssignedAgent: agent.name,
	    customLastAssignedAgentDate: new Date().toISOString(),
	    customLastAssigningUser: window.contextUserName
  	  };
    
      try {
        const res = await fetch(url, {
          method: "PUT",
          headers: {
            "accept": "application/json",
            "content-type": "application/json",
            "authorization": `Basic ${apiKey}`
          },
          body: JSON.stringify(payload)
        });
    
        if (!res.ok) throw new Error("PUT failed");
    
        const data = await res.json();
    
        if (data.assignedUserId === agent.id) {
          showRedistributeResult(agent, entry, zip);
        } else {
          throw new Error("Response did not confirm assignment.");
        }
      } catch (err) {
        console.error(err);
        alert("Redistribution failed. Try again.");
        goBack();
      }
    }
    
    function showRedistributeResult(agent, entry, zip) {
	  // Ensure calendar views are hidden when showing result
	  document.getElementById("calendarLoading").classList.add("hidden");
	  document.getElementById("calendarContainer").classList.add("hidden");
	  document.getElementById("timeSlotsContainer").classList.add("hidden");
	  document.getElementById("appointmentFormContainer").classList.add("hidden");

      const container = document.getElementById("redistributeResult");
      window.assignedAgentId = agent.id;
    
      container.innerHTML = `
        <p><strong>Redistribution Complete!</strong></p>
        <p>Zip: ${zip}</p>
        <p>Team: ${entry.team}</p>
        <p>Group: ${entry.group}</p>
        <table>
          <tr>
            <th>Photo</th>
            <th>Name</th>
            <th>Action</th>
          </tr>
          <tr>
            <td><img src="${agent.picture["60x60"]}" alt="${agent.name}" /></td>
            <td>${agent.name}</td>
            <td>
              <button type="button" class="button" style="padding:5px 10px; font-size:12px;"
                onclick="scheduleAppointment()">
                Schedule an Appointment
              </button>
            </td>
          </tr>
        </table>
      `;
    
      document.getElementById("redistributeLoading").classList.add("hidden");
      container.classList.remove("hidden");
    }

	async function initApptSetterForAssignedAgent() {
	  if (!window.contextPersonId) {
	    alert("Missing personId in context.");
	    return;
	  }
	
	  const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
	  const url = `https://api.followupboss.com/v1/people/${window.contextPersonId}`;
	
	  try {
	    const res = await fetch(url, {
	      headers: {
	        "accept": "application/json",
	        "authorization": `Basic ${apiKey}`
	      }
	    });
	
	    if (!res.ok) throw new Error("Failed to load person details");
	    const data = await res.json();
	
	    const userId = data.assignedUserId;
	    if (!userId) {
	      alert("No assigned user found for this lead.");
	      return;
	    }
	
	    window.assignedAgentId = userId;
	    window.assignedAgentName = data.assignedTo?.name || "Assigned Agent";
	
	    // Proceed to scheduling
	    showView("redistributeView");
	    document.getElementById("calendarLoading").classList.remove("hidden");
	
	    setTimeout(loadAgentAppointments, 50);
	
	  } catch (e) {
	    console.error(e);
	    alert("Failed to load assigned agent. Try using 'Help me find one!' instead.");
	  }
	}

	  
	function scheduleAppointment() {
		document.getElementById("redistributeResult").classList.add("hidden");
                document.getElementById("calendarLoading").classList.remove("hidden");


		
		// Call load AFTER setting spinner
		setTimeout(loadAgentAppointments, 50);

	}

	async function loadAgentAppointments() {
	  if (!window.assignedAgentId) {
		alert("No assigned agent found for scheduling.");
		return;
	  }

	  const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
	  const url = `https://api.followupboss.com/v1/appointments?userId=${window.assignedAgentId}&limit=100&offset=0`;

	  try {
		console.log("‚úÖ Scheduling appointments for agentId:", window.assignedAgentId);

		const res = await fetch(url, {
		  headers: {
			"accept": "application/json",
			"authorization": `Basic ${apiKey}`
		  }
		});

		if (!res.ok) throw new Error("Appointments API error");

		const data = await res.json();
		const appointments = data.appointments || [];

		window.agentBusyRanges = parseBusyWindows(appointments, window.assignedAgentId) || [];
		console.log("‚úÖ Busy ranges loaded:", window.agentBusyRanges);

		document.getElementById("calendarLoading").classList.add("hidden");
		document.getElementById("calendarContainer").classList.remove("hidden");

		renderMiniCalendar();

	  } catch (e) {
		console.error(e);
		alert("Failed to load agent appointments.");
		document.getElementById("calendarLoading").classList.add("hidden");
	  }
	}

	function renderMiniCalendar() {
	  const container = document.getElementById("calendarContainer");
	  container.innerHTML = "<h3>Select a Date:</h3>";

	  const grid = document.createElement("div");
	  grid.className = "calendar-grid";

	  const today = new Date();
	  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

	  // Headers
	  for (const d of dayNames) {
		const header = document.createElement("div");
		header.style.fontWeight = "bold";
		header.style.textAlign = "center";
		header.textContent = d;
		grid.appendChild(header);
	  }

	  // Blank cells if first day isn't Sunday
	  const firstDate = new Date(today);
	  const weekday = firstDate.getDay();
	  for (let i = 0; i < weekday; i++) {
		grid.appendChild(document.createElement("div"));
	  }

	  for (let i = 0; i < 14; i++) {
		const date = new Date(today);
		date.setDate(today.getDate() + i);

		const label = date.getDate();

		const btn = document.createElement("button");
		btn.textContent = label;
		btn.className = "button";
		btn.style.fontSize = "14px";
		btn.onclick = () => renderTimeSlots(date);

		grid.appendChild(btn);
	  }

	  container.appendChild(grid);
	}

	function renderTimeSlots(date) {
	  document.getElementById("calendarContainer").classList.add("hidden");
	  document.getElementById("timeSlotsContainer").classList.remove("hidden");

	  const container = document.getElementById("timeSlotsContainer");
	  container.innerHTML = `
		<span class="back-button" onclick="goBackToCalendar()">‚Üê Back to Calendar</span>
		<h4>${date.toDateString()}</h4>
	  `;

	  const grid = document.createElement("div");
	  grid.className = "time-grid";

	  for (let hour = 9; hour <= 18; hour++) {
		const slotStart = new Date(date);
		slotStart.setHours(hour, 0, 0, 0);

		const slotEnd = new Date(slotStart);
		slotEnd.setHours(hour + 1);

		const isBusy = window.agentBusyRanges.some(busy =>
		  slotStart < busy.end && slotEnd > busy.start
		);

		const slotLabel = slotStart.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

		const btn = document.createElement("button");
		btn.textContent = slotLabel;
		btn.className = "button";
		
		if (isBusy) {
		  btn.classList.add("busy-slot");
		  btn.title = "Agent is busy at this time";
		  btn.onclick = () => alert("This agent is not available at that time.");
		} else {
		  btn.onclick = () => showAppointmentForm(date, slotStart);
		}
		
		grid.appendChild(btn);

	  }

	  container.appendChild(grid);
	}

	// ‚úÖ ADD IT RIGHT HERE:
	function showAppointmentForm(date, slotStart) {
	  document.getElementById("timeSlotsContainer").classList.add("hidden");
	
	  const container = document.getElementById("appointmentFormContainer");
	  container.innerHTML = "";
	
	  const typeOptions = [
	    "CC Buyer - Consultation",
	    "CC Buyer - Showing Appointment",
	    "CC Seller - Consultation",
	    "ISA Buyer - Consultation",
	    "ISA Buyer - Showing Appt",
	    "ISA Seller - Consultation"
	  ];
	
	  let html = `
	    <div style="display:flex; flex-direction:column; align-items:center; max-width: 400px; margin: 0 auto;">
	      <span class="back-button" onclick="goBackToTimeSlots('${date.toISOString()}')">‚Üê Back to Time Slots</span>
	      <h4 style="margin-top:10px;">Schedule Appointment for ${date.toDateString()} at ${slotStart.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'})}</h4>
	
	      <label for="apptType" style="margin-top:10px;"><strong>Type:</strong></label>
	      <select id="apptType" style="margin: 8px 0; width: 100%;">
	        ${typeOptions.map(opt => `<option value="${opt}">${opt}</option>`).join("")}
	      </select>
	
	      <label for="apptDetails" style="margin-top:10px;"><strong>Details:</strong></label>
	      <textarea id="apptDetails" rows="3" style="width: 100%; margin-top: 8px;"></textarea>
	
	      <button class="button" style="margin-top: 16px;" onclick="submitAppointment('${slotStart.toISOString()}')">
	        Set Appointment
	      </button>
	    </div>
	  `;
	
	  container.innerHTML = html;
	  container.classList.remove("hidden");
	}

	function goBackToTimeSlots(dateIso) {
	  document.getElementById("appointmentFormContainer").classList.add("hidden");
	  renderTimeSlots(new Date(dateIso));
	}


	async function submitAppointment(startIso) {
	  const type = document.getElementById("apptType").value;
	  const details = document.getElementById("apptDetails").value || "";
	
	const type_map = {
	    "ISA Buyer - Showing Appt": 6,
	    "ISA Buyer - Consultation": 5,
	    "ISA Seller - Consultation": 4,
	    "Buyer Consultation": 7,
	    "Buyer - First Showings": 8,
	    "Seller Consultation": 9,
	    "Buyer - Zoom/Phone Call Appt": 10,
	    "Seller - Zoom/Phone Call Appt": 11,
	    "Under Contract Appt": 12,
	    "CC Buyer - Showing Appointment": 13,
	    "CC Buyer - Consultation": 14,
	    "CC Seller - Consultation": 15,
	    "Buyer - Addl Showings": 16    
	}
	
	  const typeId = type_map[type] || null;
	
	  const start = new Date(startIso);
	  const end = new Date(start);
	  end.setHours(start.getHours() + 1);
	
	  const payload = {
	    title: `${type} - ${window.assignedAgentName} and ${window.contextPersonName}`,
	    description: details,
	    start: start.toISOString(),
	    end: end.toISOString(),
	    createdById: window.contextUserId,
	    typeId: typeId,
	    invitees: [
	      {
	        userId: window.assignedAgentId,
	        userName: window.assignedAgentName
	      },
	      {
	        personId: window.contextPersonId
	      },
	      {
	        userId: window.contextUserId,
	        userName: window.contextUserName
	      }
	    ]
	  };
	
	  const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
	  const url = "https://api.followupboss.com/v1/appointments?sendInvitation=true";
	
	  try {
	    const res = await fetch(url, {
	      method: "POST",
	      headers: {
	        "accept": "application/json",
	        "content-type": "application/json",
	        "authorization": `Basic ${apiKey}`
	      },
	      body: JSON.stringify(payload)
	    });
	
	    if (!res.ok) {
	      const text = await res.text();
	      console.error("Appointment create error:", text);
	      alert("‚ùå Failed to create appointment: " + text);
	      return;
	    }
	
	    const data = await res.json();
	    console.log("‚úÖ Appointment created!", data);
	    alert("‚úÖ Appointment successfully created!");
	
	    // Go back to main menu or somewhere else
	    goBack();
	
	  } catch (err) {
	    console.error(err);
	    alert("‚ùå Failed to create appointment. Check console for details.");
	  }
	}



	function goBackToCalendar() {
	  document.getElementById("timeSlotsContainer").classList.add("hidden");
	  document.getElementById("calendarContainer").classList.remove("hidden");
	}

	async function showAvailableAgentResult(userId, userName) {
	  // Find the last searched entry so we know team, group etc.
	  const zip = window.lastZipSearch;
	  const entry = zipGroupsData.find(item => item.zip === zip);

	  if (!entry) {
		alert("Could not find zip group data for confirmation view.");
		goBack();
		return;
	  }

	  // Load agent photo from API so we can show it
	  const apiKey = "ZmthXzFlaUFMTjRieWxrMFpmNE0zRWFOMnJGR2ZmRW15Sk9QaFg6";
	  const url = `https://api.followupboss.com/v1/users/${userId}`;
	  try {
		const res = await fetch(url, {
		  headers: {
			"accept": "application/json",
			"authorization": `Basic ${apiKey}`
		  }
		});
		if (!res.ok) throw new Error("Failed to load agent info");

		const userData = await res.json();

		window.assignedAgentId = userId;
		window.assignedAgentName = userName;

		// ‚úÖ Hide all sub-views of the redistribute view so nothing remains visible underneath
		document.getElementById("calendarLoading").classList.add("hidden");
		document.getElementById("calendarContainer").classList.add("hidden");
		document.getElementById("timeSlotsContainer").classList.add("hidden");
		document.getElementById("appointmentFormContainer").classList.add("hidden");

		const container = document.getElementById("redistributeResult");

		container.innerHTML = `
		  <p><strong>Reassignment Complete!</strong></p>
		  <p>Zip: ${zip}</p>
		  <p>Team: ${entry.team}</p>
		  <p>Group: ${entry.group}</p>
		  <table>
			<tr>
			  <th>Photo</th>
			  <th>Name</th>
			  <th>Action</th>
			</tr>
			<tr>
			  <td><img src="${userData.picture["60x60"]}" alt="${userName}" /></td>
			  <td>${userName}</td>
			  <td>
				<button type="button" class="button" style="padding:5px 10px; font-size:12px;"
				  onclick="scheduleAppointment()">
				  Schedule an Appointment
				</button>
			  </td>
			</tr>
		  </table>
		`;

		document.getElementById("agentsTableContainer").classList.add("hidden");
		document.getElementById("agentsLoading").classList.add("hidden");
		document.getElementById("agentsForm").classList.add("hidden");

		// Switch views cleanly
		showView("redistributeView");
		document.getElementById("redistributeResult").classList.remove("hidden");

	  } catch (err) {
		console.error(err);
		alert("Could not load agent details for confirmation view.");
		goBack();
	  }
	}


	function parseBusyWindows(appointments, agentId) {
	  const bufferMs = 60 * 60 * 1000; // 1 hour buffer before and after
	
	  return appointments
	    .filter(appt =>
	      Array.isArray(appt.invitees) &&
	      appt.invitees.some(invitee => invitee.userId === agentId)
	    )
	    .map(appt => {
	      const start = new Date(appt.start);
	      const end = new Date(appt.end);
	      return {
	        start: new Date(start.getTime() - bufferMs),
	        end: new Date(end.getTime() + bufferMs)
	      };
	    });
	}


	function showBanner(message, type = "info", duration = 4000) {
	  const banner = document.getElementById("notificationBanner");
	  banner.className = ""; // Clear previous state
	  banner.textContent = message;
	
	  // Add correct styling class
	  banner.classList.add(
	    type === "error" ? "error" :
	    type === "success" ? "success" :
	    type === "warning" ? "warning" : "info"
	  );
	
	  banner.classList.remove("hidden");
	
	  // Auto-hide after duration
	  setTimeout(() => {
	    banner.classList.add("hidden");
	  }, duration);
	}

	    
  </script>
</body>
</html>
