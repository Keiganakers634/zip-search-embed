<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FUB + Zapier Embedded App</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }
    .debug-box {
      background: #f0f0f0;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 20px;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
  <!-- Zapier Web Component -->
  <script type='module' src='https://interfaces.zapier.com/assets/web-components/zapier-interfaces/zapier-interfaces.esm.js'></script>

  <!-- Follow Up Boss embeddedApps script (optional if needed) -->
  <script type="text/javascript" src="https://eia.followupboss.com/embeddedApps-v1.0.1.js"></script>
</head>

<body>
  <!-- Zapier embed container (initially hidden) -->
  <div id="zapierEmbed" style="display: none;">
    <zapier-interfaces-page-embed
      page-id='cm98vlopd001611ck4v8vy46l'
      no-background='false'
      allow-query-params='true'
      query-params=''
      style='max-width: 900px; height: 500px;'
    ></zapier-interfaces-page-embed>
  </div>

  <script>
    async function verifyContextAndShowData() {
      const secret = "f38bd4dfb990d163f4f8bc070cc1da16";

      const params = new URLSearchParams(window.location.search);
      const contextB64 = params.get("context");
      const signature = params.get("signature");

      if (!contextB64 || !signature) {
        document.body.insertAdjacentHTML(
          "afterbegin",
          `<div style="background:#ffdddd; padding:10px; color:#800;">
            ‚ö†Ô∏è No context or signature found in URL.
          </div>`
        );
        return;
      }

      try {
        const decodedString = atob(contextB64);
        const contextObj = JSON.parse(decodedString);

        // Validate signature
        const enc = new TextEncoder();
        const key = await crypto.subtle.importKey(
          "raw",
          enc.encode(secret),
          { name: "HMAC", hash: "SHA-256" },
          false,
          ["sign"]
        );

        const sigBuffer = await crypto.subtle.sign(
          "HMAC",
          key,
          enc.encode(contextB64)
        );

        const calculatedSig = Array.from(new Uint8Array(sigBuffer))
          .map(b => b.toString(16).padStart(2, "0"))
          .join("");

        if (calculatedSig === signature) {
          console.log("‚úÖ Signature is valid!");

          const userName = contextObj?.user?.name || "(Unknown)";
          const userEmail = contextObj?.user?.email?.toLowerCase() || "(Unknown)";

          // Show Current User info
          const userHtml = `
            <div style="background:#eef; padding:10px; border:1px solid #99f; margin-bottom:20px;">
              üë§ <strong>Current User:</strong> ${userName} (${userEmail})
            </div>
          `;
          document.body.insertAdjacentHTML("afterbegin", userHtml);

          // Show decoded JSON for debugging
          const debugHtml = `
            <div class="debug-box">
              <strong>Decoded FUB Context:</strong><br>
              ${JSON.stringify(contextObj, null, 2)}
            </div>
          `;
          document.body.insertAdjacentHTML("afterbegin", debugHtml);

          // ‚úÖ AUTHORIZATION CHECK
          const authorizedEmails = [
            "keigan.akers@robertslack.com",
            "fubadmin@robertslack.com",
            "cat.flanagan@robertslack.com",
            "gabe.cordova@robertslack.com",
            "francisco.garcia@robertslack.com"
          ];

          const zapierEmbed = document.getElementById("zapierEmbed");

          if (authorizedEmails.includes(userEmail)) {
            zapierEmbed.style.display = "block";
            console.log("‚úÖ User authorized:", userEmail);
          } else {
            zapierEmbed.style.display = "none";
            const unauthorizedHtml = `
              <div style="background:#ffdddd; padding:15px; color:#800; border:1px solid #f00; margin-top:20px;">
                ‚ùå <strong>Unauthorized user:</strong> This internal tool is for Call Center and Lisa team members!
              </div>
            `;
            document.body.insertAdjacentHTML("beforeend", unauthorizedHtml);
            console.log("‚ùå User unauthorized:", userEmail);
          }
        } else {
          console.error("‚ùå Signature verification failed!");
          document.body.insertAdjacentHTML(
            "afterbegin",
            `<div style="background:#ffdddd; padding:10px; color:#800;">
              ‚ùå Signature verification failed!
            </div>`
          );
        }
      } catch (e) {
        console.error("Error decoding context:", e);
        document.body.insertAdjacentHTML(
          "afterbegin",
          `<div style="background:#ffdddd; padding:10px; color:#800;">
            ‚ùå Error decoding context data.
          </div>`
        );
      }
    }

    verifyContextAndShowData();
  </script>
</body>
</html>
